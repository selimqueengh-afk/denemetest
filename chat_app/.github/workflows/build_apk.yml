name: ğŸš€ Android APK Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: ğŸ“± Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java 11
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'
        
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.8'
        channel: 'stable'
        cache: true
        
    - name: ğŸ“¦ Get Flutter dependencies
      run: flutter pub get
      
    - name: ğŸ§¹ Clean project
      run: flutter clean
      
    - name: ğŸ”§ Analyze code
      run: flutter analyze
      
    - name: ğŸ—ï¸ Build APK (Release)
      run: |
        flutter build apk --release \
          --target-platform android-arm,android-arm64,android-x64 \
          --split-per-abi
          
    - name: ğŸ—ï¸ Build APK (Universal)
      run: |
        flutter build apk --release \
          --target-platform android-arm,android-arm64,android-x64
          
    - name: ğŸ“± Rename APK files
      run: |
        mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/sohbet-uygulamasi-universal.apk
        
    - name: ğŸ“¤ Upload Universal APK
      uses: actions/upload-artifact@v4
      with:
        name: ğŸ“± Sohbet UygulamasÄ± (Universal APK)
        path: build/app/outputs/flutter-apk/sohbet-uygulamasi-universal.apk
        retention-days: 30
        
    - name: ğŸ“¤ Upload Split APKs
      uses: actions/upload-artifact@v4
      with:
        name: ğŸ“± Sohbet UygulamasÄ± (Split APKs)
        path: build/app/outputs/flutter-apk/app-*-release.apk
        retention-days: 30
        
    - name: ğŸ“Š APK Info
      run: |
        echo "ğŸ“± APK Build Completed!"
        echo "ğŸ“ Universal APK: build/app/outputs/flutter-apk/sohbet-uygulamasi-universal.apk"
        echo "ğŸ“¦ APK Size:"
        ls -lh build/app/outputs/flutter-apk/*.apk
        
    - name: ğŸ‰ Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/app/outputs/flutter-apk/sohbet-uygulamasi-universal.apk
          build/app/outputs/flutter-apk/app-*-release.apk
        name: Sohbet UygulamasÄ± ${{ github.ref_name }}
        body: |
          ğŸ‰ **Sohbet UygulamasÄ± Yeni SÃ¼rÃ¼m!**
          
          ğŸ“± **Android APK DosyalarÄ±:**
          - `sohbet-uygulamasi-universal.apk` - TÃ¼m cihazlar iÃ§in (Ã–nerilen)
          - Split APK'lar - Belirli mimariler iÃ§in
          
          ğŸ“‹ **Ã–zellikler:**
          - âœ… Ã‡oklu sohbet odalarÄ±
          - âœ… GerÃ§ek zamanlÄ± mesajlaÅŸma
          - âœ… KullanÄ±cÄ± profil yÃ¶netimi  
          - âœ… Yerel veri saklama
          - âœ… Modern Material Design UI
          
          ğŸ“² **Kurulum:**
          1. Universal APK'yÄ± indirin
          2. Android cihazÄ±nÄ±zda "Bilinmeyen kaynaklar"Ä± etkinleÅŸtirin
          3. APK'yÄ± yÃ¼kleyin
          4. UygulamayÄ± aÃ§Ä±n ve kullanmaya baÅŸlayÄ±n!
          
          âš ï¸ **Minimum Gereksinimler:**
          - Android 5.0+ (API 21)
          - 50MB boÅŸ alan
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}